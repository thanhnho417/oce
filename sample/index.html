<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Playlist Test</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/sample/style.css" />
</head>

<body>
  <div class="vid-player-container">
    <div class="vid-main-video">
      <div class="vid-play">
        <video class="vid-player" controls playsinline>

        </video>
      </div>
      <div class="vid-main-info">
        <h3 class="vid-title">Video Test</h3>
        <p class="vid-description">A brief description of the video content goes here.</p>
      </div>
    </div>
    <div class="vid-playlist">

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const vid = document.querySelector('.vid-player');
      const vidplaylist = document.querySelector('.vid-playlist');
      const viddescription = document.querySelector('.vid-description');
      const vidtitle = document.querySelector('.vid-title');

      let player = new Plyr(vid);
      let hls = null;

      function plyrset() {
        const wrapper = vid.closest('.vid-play');
        const plyrcontainer = wrapper?.querySelector('.plyr');
        const interval = setInterval(() => {
          const old = plyrcontainer?.querySelector('.vid-watermark');
          if (old) old.remove();
          if (plyrcontainer) {
            const watermark = document.createElement('div');
            watermark.className = 'vid-watermark';
            watermark.innerHTML = `
          <img src="/watermark.png" alt="vid-watermark" class="vid-main-watermark">
          <img class="vid-age-watermark" src="/sample/image.svg" alt="vid-age-watermark">
        `;
            plyrcontainer.appendChild(watermark);
            clearInterval(interval);
          }
        }, 100);
      }

      function loadvideosource(item) {
        const vidsrc = item.getAttribute('data-src');
        const title = item.querySelector('.vid-playlist-title')?.textContent || 'Video Title';
        const desc = item.getAttribute('data-description') || 'No description available.';
        const ext = vidsrc.split('.').pop().toLowerCase();
        const vidsubtitle = JSON.parse(item.getAttribute('data-subtitle') || '[]');

        if (hls) {
          hls.destroy();
          hls = null;
        }

        vid.pause();
        vid.removeAttribute('src');
        vid.querySelectorAll('track').forEach(track => track.remove());

        // GÁN PHỤ ĐỀ MỚI
        if (vidsubtitle.length > 0) {
          vidsubtitle.forEach((vidsub, i) => {
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = vidsub.label || 'Subtitles';
            track.srclang = vidsub.lang || 'en';
            track.src = vidsub.src;
            if (i === 0) {
              track.setAttribute('default', '');
            }
            vid.appendChild(track);
          });
        }

        // RESET VIDEO
        vid.load();

        vidtitle.textContent = title;
        viddescription.textContent = desc;

        function enableSubtitles() {
          if (vidsubtitle.length > 0) {
            player.toggleCaptions(true);
          } else {
            player.toggleCaptions(false);
          }
        }

        const onReady = () => {
          plyrset();
          // Bắt buộc đợi video `loadeddata`, để trình duyệt thật sự phân tích phụ đề
          vid.addEventListener('loadeddata', () => {
            setTimeout(() => {
              enableSubtitles();
            }, 100); // nhỏ thôi để chờ Plyr "bắt" được track
          }, { once: true });
        };

        if (ext === 'm3u8') {
          if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(vidsrc);
            hls.attachMedia(vid);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              onReady();
            });
          } else if (vid.canPlayType('application/vnd.apple.mpegurl')) {
            vid.src = vidsrc;
            vid.addEventListener('loadedmetadata', onReady, { once: true });
          } else {
            console.error('HLS not supported');
          }
        } else {
          vid.src = vidsrc;
          vid.addEventListener('loadedmetadata', onReady, { once: true });
        }
      }

      function buildPlaylist(data) {
        vidplaylist.innerHTML = '<p class="vid-playlist-main-title">Playlist</p><hr>';
        data.forEach(item => {
          const viditem = document.createElement('div');
          viditem.className = 'vid-playlist-item';
          viditem.setAttribute('data-src', item.src);
          viditem.setAttribute('data-description', item.description || '');
          viditem.setAttribute('data-subtitle', JSON.stringify(item.subtitle || []));
          viditem.innerHTML = `
        <img src="${item.image || '/sample/vna.png'}" alt="${item.title}" class="vid-playlist-thumbnail">
        <p class="vid-playlist-title">${item.title}</p>
      `;
          viditem.addEventListener('click', () => loadvideosource(viditem));
          vidplaylist.appendChild(viditem);
        });
      }

      fetch('/sample/test.json')
        .then(res => res.json())
        .then(data => {
          buildPlaylist(data);
          if (data.length > 0) {
            const firstitem = vidplaylist.querySelector('.vid-playlist-item');
            loadvideosource(firstitem);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        })
        .catch(err => console.error('Playlist error:', err));
    });






  </script>



</body>

</html>
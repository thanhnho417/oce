<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Playlist Test</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/sample/style.css" />
</head>

<body>
  <div class="vid-player-container">
    <div class="vid-main-video">
      <div class="vid-play">
        <video class="vid-player" controls playsinline crossorigin="anonymous"></video>
      </div>
      <div class="vid-main-info">
        <h3 class="vid-title">Video Test</h3>
        <p class="vid-description">A brief description of the video content goes here.</p>
      </div>
    </div>
    <div class="vid-playlist"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const vid = document.querySelector('.vid-player');
      const vidplaylist = document.querySelector('.vid-playlist');
      const vidmaintitle = document.querySelector('.vid-title');
      const vidmaindescription = document.querySelector('.vid-description');
      let hls = null;
      let vidfull = false

      function vidactualsize(video) {
        const vidwidth = video.videoWidth;
        const vidheight = video.videoHeight;
        const scrwidth = window.innerWidth;
        const scrheight = window.innerHeight;
        const vidasp = vidwidth / vidheight;
        const scrasp = scrwidth / scrheight;
        let diswidth, disheight;
        if (scrasp > vidasp) {
          diswidth = scrheight * vidasp;
          disheight = scrheight;
        } else {
          diswidth = scrwidth;
          disheight = scrwidth / vidasp;
        }
        return {
          width: diswidth,
          height: disheight
        };
      }



      document.addEventListener('fullscreenchange', () => {
        vidfull = document.fullscreenElement && document.fullscreenElement.contains(vid)
        vidupdate()
      })
      window.addEventListener('resize', vidupdate)


      const player = new Plyr(vid, {
        captions: { active: true, update: true, language: 'auto' }
      });

      function vidaddwatermark() {
        const interval = setInterval(() => {
          const plyrcontainer = vid.closest('.vid-play').querySelector('.plyr');
          if (plyrcontainer && !plyrcontainer.querySelector('.vid-watermark')) {
            const watermark = document.createElement('div');
            watermark.className = 'vid-watermark';
            watermark.innerHTML = `
        <img src="/watermark.png" alt="vid-watermark" class="vid-main-watermark">
        <img src="/sample/image.svg" class="vid-age-watermark">
      `;
            plyrcontainer.appendChild(watermark);
            setTimeout(() => {
              vidupdate(); // cập nhật kích thước watermark sau khi nó được thêm
            }, 100);
          }
          clearInterval(interval);
        }, 100);
      }

      function resetPlayer() {
        if (hls) {
          hls.destroy();
          hls = null;
        }

        // Remove all child nodes (sources, tracks)
        while (vid.firstChild) {
          vid.removeChild(vid.firstChild);
        }

        // Reset video attributes
        vid.removeAttribute('src');
        vid.load();
      }

      function loadMediaSource(item) {
        resetPlayer();

        const isHls = item.src.endsWith('.m3u8');
        const mediaType = isHls ? 'application/x-mpegURL' : 'video/mp4';

        // Update UI title/desc
        vidmaintitle.textContent = item.title || 'Video Title';
        vidmaindescription.textContent = item.description || 'Video Description';

        if (isHls) {
          if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(item.src);
            hls.attachMedia(vid);
            hls.on(Hls.Events.MANIFEST_PARSED, function () {
              vidaddwatermark()
              addSubtitles(item);
              player.load();
            });
          } else if (vid.canPlayType('application/vnd.apple.mpegurl')) {
            vid.src = item.src;
            vid.addEventListener('loadedmetadata', () => {
              addSubtitles(item);
              vidaddwatermark();
              player.load();
            }, { once: true });
          }
        } else {
          const source = document.createElement('source');
          source.src = item.src;
          source.type = mediaType;
          vid.appendChild(source);
          addSubtitles(item);
          vid.load();
          vidaddwatermark()

        }
      }

      function addSubtitles(item) {
        const exttrack = vid.querySelectorAll('track');
        exttrack.forEach(track => track.remove()); // Remove existing tracks
        let hasDefault = -1;
        if (item.subtitle && item.subtitle.length > 0) {
          item.subtitle.forEach((sub, index) => {
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = sub.label || `Subtitle ${index + 1}`;
            track.srclang = sub.lang || 'en';
            track.src = sub.src;
            if (sub.default) {
              track.default = true;
              hasDefault = index;
            }
            vid.appendChild(track);
          });
        }
        setTimeout(() => {
          if (hasDefault !== -1) {
            player.currentTrack = hasDefault;
            player.toggleCaptions(true);
          }
        }, 500)
      }

      function loadPlaylist() {
        fetch('/sample/test.json')
          .then(response => response.json())
          .then(data => {
            vidplaylist.innerHTML = `
            <p class="vid-playlist-main-title">Playlist</p>
              <hr>
            `
            data.forEach((video, index) => {
              const item = document.createElement('div');
              item.className = 'vid-playlist-item';
              item.innerHTML = `
                <img src="${video.image || '/sample/vna.png'}" alt="${video.title}" class="vid-playlist-thumbnail">
                <p class="vid-playlist-title">${video.title}</p>
              `;

              item.addEventListener('click', () => {
                document.querySelectorAll('.vid-playlist-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                loadMediaSource(video);
              });

              vidplaylist.appendChild(item);

              if (index === 0) {
                item.classList.add('active');
                loadMediaSource(video);
              }
            });
          })
          .catch(error => console.error('Error loading playlist:', error));
      }

      loadPlaylist();

      function vidupdate() {
        const vidwatermark = document.querySelector('.vid-watermark')
        if (!vidwatermark) {
          console.log('Không tìm thấy')
          return
        }
        if (vidfull && vidwatermark && vid.videoWidth && vid.videoHeight) {
          const size = vidactualsize(vid);
          vidwatermark.style.width = size.width + 'px'
          vidwatermark.style.height = size.height + 'px'
        } else {
          vidwatermark.style.width = '100%'
          vidwatermark.style.height = '100%'
        }
      }
      window.addEventListener('resize', vidupdate)
    });
  </script>
</body>

</html>